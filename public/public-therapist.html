<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>EMDR Therapist Control</title>
  <style>
    /* ...スタイルは変更なし... */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }
    #controlPanel {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      text-align: center;
      z-index: 10;
    }
    #slider {
      width: 300px;
    }
    #startBtn, #stopBtn {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    #ball {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background-color: #FFB3BF;
    }
    select {
      margin-top: 8px;
      padding: 5px;
      font-size: 14px;
    }
    option {
      padding: 4px;
    }
  </style>
</head>
<body style="background-color: #000000;">

  <div id="controlPanel">
    <!-- ... UI要素は変更なし ... -->
  </div>
  <div id="ball"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const slider = document.getElementById("slider");
    const speedDisplay = document.getElementById("speedDisplay");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const ball = document.getElementById("ball");
    const ballColor = document.getElementById("ballColor");
    const bgColor = document.getElementById("bgColor");

    // ▼ここから修正▼: ボールの初期位置を中央に設定
    let position = (window.innerWidth - 50) / 2; // 50はボールの幅
    ball.style.left = position + "px";
    // ▲ここまで修正▲
    
    let direction = 1;
    let speed = parseInt(slider.value);
    let animationId = null;

    // ... populateColorSelect, getContrastYIQ, イベントリスナーなどは変更なし ...
    const ballColors = [
      "#FFE3CB", "#FFB3BF", "#F5CEE6", "#C5E8F2", "#C3D4F3",
      "#BCE0DF", "#DFF5D6", "#FFFAD1", "#FA8072", "#FFFF00",
      "#800080", "#008000", "#9ACD32", "#00FFFF", "#7FFFD4", "#0000FF"
    ];
    const bgColors = [
      "#FFFFFF", "#FFFAFA", "#F0FFFF", "#FFFFF0", "#C0C0C0", "#000000"
    ];
    function populateColorSelect(selectElem, colorList) {
      colorList.forEach(color => {
        const option = document.createElement("option");
        option.value = color;
        option.textContent = `⬛ ${color}`;
        option.style.backgroundColor = color;
        option.style.color = getContrastYIQ(color) === "black" ? "#000" : "#fff";
        selectElem.appendChild(option);
      });
    }
    function getContrastYIQ(hexcolor) {
      hexcolor = hexcolor.replace("#", "");
      const r = parseInt(hexcolor.substr(0,2),16);
      const g = parseInt(hexcolor.substr(2,2),16);
      const b = parseInt(hexcolor.substr(4,2),16);
      const yiq = ((r*299)+(g*587)+(b*114))/1000;
      return (yiq >= 128) ? 'black' : 'white';
    }
    populateColorSelect(ballColor, ballColors);
    populateColorSelect(bgColor, bgColors);
    ballColor.value = "#FFB3BF";
    bgColor.value = "#000000";
    
    slider.addEventListener("input", () => {
      speed = parseInt(slider.value);
      speedDisplay.textContent = speed;
      socket.emit("ball-control", { type: "speed", value: speed });
    });
    startBtn.addEventListener("click", () => {
      socket.emit("ball-control", { type: "start" });
      if (!animationId) {
        moveBall();
      }
    });
    stopBtn.addEventListener("click", () => {
      socket.emit("ball-control", { type: "stop" });
      stopBall();
    });
    ballColor.addEventListener("change", () => {
      const color = ballColor.value;
      ball.style.backgroundColor = color;
      socket.emit("ball-control", { type: "ballColor", value: color });
    });
    bgColor.addEventListener("change", () => {
      const color = bgColor.value;
      document.body.style.backgroundColor = color;
      socket.emit("ball-control", { type: "bgColor", value: color });
    });


    function moveBall() { /* ...変更なし... */ }
    function stopBall() { /* ...変更なし... */ }
    socket.on("ball-control", (data) => { /* ...変更なし... */ });
    
    function moveBall() {
      const ballWidth = 50;
      const screenWidth = window.innerWidth;
      position += direction * speed;
      if (position <= 0 || position + ballWidth >= screenWidth) {
        direction *= -1;
        position = Math.max(0, Math.min(position, screenWidth - ballWidth));
      }
      ball.style.left = position + "px";
      animationId = requestAnimationFrame(moveBall);
    }
    function stopBall() {
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    }
    socket.on("ball-control", (data) => {
      if (data.type === "start") {
        if (!animationId) {
            moveBall();
        }
      } else if (data.type === "stop") {
        stopBall();
      } else if (data.type === "speed") {
        speed = data.value;
      } else if (data.type === "ballColor") {
        const color = data.value;
        ball.style.backgroundColor = color;
        ballColor.value = color; 
      } else if (data.type === "bgColor") {
        const color = data.value;
        document.body.style.backgroundColor = color;
        bgColor.value = color;
      }
    });


    // ▼ここから修正▼: リサイズ時の処理を改善
    window.addEventListener("resize", () => {
      const ballWidth = 50;
      // ボールが動いていない（停止中）の場合、常に中央に再配置
      if (!animationId) {
        position = (window.innerWidth - ballWidth) / 2;
      } else {
        // 動いている場合は、画面右端からはみ出ないように補正
        if (position + ballWidth > window.innerWidth) {
          position = window.innerWidth - ballWidth;
        }
      }
      ball.style.left = position + 'px';
    });
    // ▲ここまで修正▲
  </script>
</body>
</html>
