<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>EMDR Control Panel</title>
  <style>
    body { font-family: sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; }
    #controlPanel, #previewContainer { display: none; }
    #controlPanel { display: flex; flex-wrap: wrap; gap: 20px; max-width: 1200px; margin: auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .control-group { border: 1px solid #ddd; border-radius: 8px; padding: 15px; flex: 1 1 250px; min-width: 250px; }
    .control-group > label:first-of-type { text-align: center; display: block; font-weight: bold; margin-bottom: 10px; color: #555; }
    .control-group button, .control-group select, .control-group input[type="range"] { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 15px; box-sizing: border-box; }
    .control-group button { background-color: #5c67f2; color: white; border: none; cursor: pointer; transition: background-color 0.2s; }
    #toggleMoveBtn.stop-active, #toggleVibrationBtn.stop-active { background-color: #f25c5c; }
    #pauseResumeBtn { background-color: #e67e22; }
    #pauseResumeBtn.resume-active { background-color: #2ecc71; }
    .button-group { display: flex; gap: 5px; }
    .button-group button { width: 100%; font-size: 18px; padding: 8px 0; }
    .toggle-switch { display: flex; align-items: center; justify-content: center; gap: 10px; }
    .toggle-switch span { white-space: nowrap; }
    .slider-group { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; } /* ★修正④ */
    .slider-group label { margin-bottom: 0; white-space: nowrap; } /* ★修正④ */
    .slider-group input { width: 100%; margin-bottom: 0; } /* ★修正④ */
    #previewContainer { max-width: 1200px; margin: 30px auto; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    #previewArea { width: 100%; height: 250px; background-color: #000000; position: relative; overflow: hidden; }
    #previewBall { width: 30px; height: 30px; border-radius: 50%; background-color: #FFFFFF; position: absolute; }
  </style>
</head>
<body>
  <div id="controlPanel">
    <div class="control-group">
      <label>視覚刺激（ボール）</label>
      <button id="toggleMoveBtn">開始</button>
      <button id="pauseResumeBtn">一時停止</button>
      <select id="movePattern"> <option value="horizontal">水平</option> <option value="diagonal1">斜め（＼）</option> <option value="diagonal2">斜め（／）</option> </select>
      <div class="slider-group">
        <label for="speedSlider">速さ:</label><input type="range" id="speedSlider" min="1" max="100" value="5" /><span id="speedValue">5</span>
      </div>
    </div>
    <div class="control-group">
      <label>聴覚刺激</label>
      <div class="button-group"> <button id="prevTrackBtn">«</button> <button id="playPauseBtn">▶</button> <button id="nextTrackBtn">»</button> </div>
      <div class="slider-group">
        <label>音量:</label><input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.7"><span id="volumeValue">50</span>%
      </div>
      <hr style="margin: 15px 0;">
      <div class="toggle-switch"> <span>衝突音</span> <input type="checkbox" id="audioToggle"> </div>
      <select id="collisionSoundType"> <option value="sine_high">サイン波 (高)</option> <option value="sine_low">サイン波 (低)</option> <option value="click">クリック</option> </select>
    </div>
    <div class="control-group">
      <label>触覚刺激（振動）</label>
      <button id="toggleVibrationBtn">開始</button>
      <div class="slider-group">
        <label for="vibrationIntervalSlider">間隔:</label><input type="range" id="vibrationIntervalSlider" min="300" max="2000" step="50" value="1000" /><span id="vibrationIntervalValue">1000</span>ms
      </div>
    </div>
    <div class="control-group"> <label>共通設定</label> <select id="ballColor"></select> <select id="bgColor"></select> </div>
  </div>
  <div id="previewContainer"> <h3>クライアント画面プレビュー</h3> <div id="previewArea"> <div id="previewBall"></div> </div> </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const correctPassword = "jr3w4sau4"; const enteredPassword = prompt("パスワードを入力してください:"); if (enteredPassword !== correctPassword) { document.body.innerHTML = `<h1>アクセス拒否</h1>`; return; }
      document.getElementById('controlPanel').style.display = 'flex'; document.getElementById('previewContainer').style.display = 'block';
      const socket = io();
      // ★修正①②: 要素取得を元の確実な方法に戻す
      const toggleMoveBtn = document.getElementById('toggleMoveBtn'), pauseResumeBtn = document.getElementById('pauseResumeBtn'), speedSlider = document.getElementById('speedSlider'), speedValue = document.getElementById('speedValue'), movePatternSelect = document.getElementById('movePattern'), audioToggle = document.getElementById('audioToggle'), ballColorSelect = document.getElementById('ballColor'), bgColorSelect = document.getElementById('bgColor'), volumeSlider = document.getElementById('volumeSlider'), volumeValue = document.getElementById('volumeValue'), playPauseBtn = document.getElementById('playPauseBtn'), prevTrackBtn = document.getElementById('prevTrackBtn'), nextTrackBtn = document.getElementById('nextTrackBtn'), collisionSoundType = document.getElementById('collisionSoundType'), toggleVibrationBtn = document.getElementById('toggleVibrationBtn'), vibrationIntervalSlider = document.getElementById('vibrationIntervalSlider'), vibrationIntervalValue = document.getElementById('vibrationIntervalValue'), previewArea = document.getElementById('previewArea'), previewBall = document.getElementById('previewBall');
      let isBallMoving = false, isPaused = false, isVibrating = false, isMusicPlaying = false;
      
      // ★修正⑤: セラピスト側のローカルBGM再生機能
      const therapistAudioPlayer = new Audio();
      const musicPlaylist=['/audio/1 Blue Berry Pufffin.mp3','/audio/2 A Step In The River.mp3','/audio/3 Peak\'s Performance.mp3','/audio/4 Jazz Hoyt.mp3','/audio/5 Pop\'s Trilogy.mp3','/audio/6 Redemption.mp3','/audio/7 Oceanic Fellings.mp3','/audio/8 Paco Bell.mp3','/audio/9 Round The Lake.mp3','/audio/10 Piano R Squared.mp3','/audio/11 New (No) Frills - Shaken, Not Stirred.mp3'];
      let shuffledPlaylist = [], currentTrackIndex = 0;
      function shufflePlaylist(e){const t=[...e];for(let o=t.length-1;o>0;o--){const l=Math.floor(Math.random()*(o+1));[t[o],t[l]]=[t[l],t[o]]}return t}
      function loadAndPlayTherapistMusic(index) {
          if (shuffledPlaylist.length === 0) shuffledPlaylist = shufflePlaylist(musicPlaylist);
          currentTrackIndex = (index + shuffledPlaylist.length) % shuffledPlaylist.length;
          therapistAudioPlayer.src = shuffledPlaylist[currentTrackIndex];
          if (isMusicPlaying) therapistAudioPlayer.play();
      }
      therapistAudioPlayer.addEventListener('ended', () => loadAndPlayTherapistMusic(currentTrackIndex + 1));

      playPauseBtn.addEventListener('click', () => { isMusicPlaying = !isMusicPlaying; socket.emit("music-control", { type: isMusicPlaying ? 'play' : 'pause' }); playPauseBtn.textContent = isMusicPlaying ? '❚❚' : '▶'; if(isMusicPlaying){ if(therapistAudioPlayer.src === ''){loadAndPlayTherapistMusic(0);}else{therapistAudioPlayer.play();} } else { therapistAudioPlayer.pause(); } });
      prevTrackBtn.addEventListener('click', () => { socket.emit("music-control", { type: 'prev' }); loadAndPlayTherapistMusic(currentTrackIndex - 1); });
      nextTrackBtn.addEventListener('click', () => { socket.emit("music-control", { type: 'next' }); loadAndPlayTherapistMusic(currentTrackIndex + 1); });
      
      volumeSlider.addEventListener('input', () => { const volume = parseFloat(volumeSlider.value); const displayVolume = Math.round(Math.pow(volume, 2) * 100); volumeValue.textContent = displayVolume; therapistAudioPlayer.volume = Math.pow(volume, 2); socket.emit("ball-control", { type: "volume", value: Math.pow(volume, 2) }); });
      collisionSoundType.addEventListener('change', () => socket.emit("ball-control", { type: "collisionSound", value: collisionSoundType.value }));
      const previewBallSize={width:30,height:30};let previewPosition,previewDirection,previewAnimationId=null;const angle=15,angleRad=angle*Math.PI/180,dirX=Math.cos(angleRad),dirY=Math.sin(angleRad);let isPreviewStopping=false,hasPreviewReachedEdge=false,previewStopProgress=0;const previewStopDuration=120;let previewReturnStartPosition;function resetPreviewBallPosition(){if(previewAnimationId)cancelAnimationFrame(previewAnimationId);previewAnimationId=null;const e=previewArea.getBoundingClientRect();previewPosition={x:(e.width-previewBallSize.width)/2,y:(e.height-previewBallSize.height)/2};previewBall.style.left=previewPosition.x+'px';previewBall.style.top=previewPosition.y+'px'}function updatePreviewDirection(){const e=movePatternSelect.value;switch(e){case'horizontal':previewDirection={x:1,y:0};break;case'diagonal1':previewDirection={x:dirX,y:dirY};break;case'diagonal2':previewDirection={x:-dirX,y:dirY};break}}function stopPreviewBall(){if(previewAnimationId&&!isPreviewStopping){isPreviewStopping=true;hasPreviewReachedEdge=false}}
      function movePreviewBall(){if(isPaused){previewAnimationId=requestAnimationFrame(movePreviewBall);return}const speed=parseInt(speedSlider.value,10);const areaRect=previewArea.getBoundingClientRect();if(isPreviewStopping){if(!hasPreviewReachedEdge){previewPosition.x+=previewDirection.x*speed;previewPosition.y+=previewDirection.y*speed;if(previewPosition.x<=0||previewPosition.x+previewBallSize.width>=areaRect.width||previewPosition.y<=0||previewPosition.y+previewBallSize.height>=areaRect.height){hasPreviewReachedEdge=true;previewReturnStartPosition={...previewPosition};previewStopProgress=0}}else{const center={x:(areaRect.width-previewBallSize.width)/2,y:(areaRect.height-previewBallSize.height)/2};previewStopProgress+=1/previewStopDuration;const ease=1-Math.pow(1-previewStopProgress,3);previewPosition.x=previewReturnStartPosition.x+(center.x-previewReturnStartPosition.x)*ease;previewPosition.y=previewReturnStartPosition.y+(center.y-previewReturnStartPosition.y)*ease;if(previewStopProgress>=1){resetPreviewBallPosition();isPreviewStopping=false;return}}}else{previewPosition.x+=previewDirection.x*speed;previewPosition.y+=previewDirection.y*speed;if(movePatternSelect.value!=='horizontal'&&(previewPosition.x<=0||previewPosition.x+previewBallSize.width>=areaRect.width||previewPosition.y<=0||previewPosition.y+previewBallSize.height>=areaRect.height)){previewDirection.x*=-1;previewDirection.y*=-1}else if(movePatternSelect.value==='horizontal'&&(previewPosition.x<=0||previewPosition.x+previewBallSize.width>=areaRect.width)){previewDirection.x*=-1}}previewPosition.x=Math.max(0,Math.min(previewPosition.x,areaRect.width-previewBallSize.width));previewPosition.y=Math.max(0,Math.min(previewPosition.y,areaRect.height-previewBallSize.height));previewBall.style.left=previewPosition.x+'px';previewBall.style.top=previewPosition.y+'px';previewAnimationId=requestAnimationFrame(movePreviewBall)}
      toggleMoveBtn.addEventListener('click',()=>{isBallMoving=!isBallMoving;if(isBallMoving){socket.emit("ball-control",{type:"start"});toggleMoveBtn.textContent='停止';toggleMoveBtn.classList.add('stop-active');isPreviewStopping=false;hasPreviewReachedEdge=false;updatePreviewDirection();if(!previewAnimationId)previewAnimationId=requestAnimationFrame(movePreviewBall)}else{socket.emit("ball-control",{type:"stop"});toggleMoveBtn.textContent='開始';toggleMoveBtn.classList.remove('stop-active');stopPreviewBall();isPaused=false;pauseResumeBtn.textContent='一時停止';pauseResumeBtn.classList.remove('resume-active')}});pauseResumeBtn.addEventListener('click',()=>{if(!isBallMoving)return;isPaused=!isPaused;socket.emit("ball-control",{type:"pause-resume"});if(isPaused){pauseResumeBtn.textContent='再開';pauseResumeBtn.classList.add('resume-active')}else{pauseResumeBtn.textContent='一時停止';pauseResumeBtn.classList.remove('resume-active')}});toggleVibrationBtn.addEventListener('click',()=>{isVibrating=!isVibrating;socket.emit(isVibrating?"vibration-start":"vibration-stop",{interval:parseInt(vibrationIntervalSlider.value,10)});toggleVibrationBtn.textContent=isVibrating?'停止':'開始';toggleVibrationBtn.classList.toggle('stop-active',isVibrating)});vibrationIntervalSlider.addEventListener('input',()=>{const e=parseInt(vibrationIntervalSlider.value,10);vibrationIntervalValue.textContent=e;socket.emit("vibration-interval",{interval:e})});
      speedSlider.addEventListener('input',()=>{const e=parseInt(speedSlider.value,10);speedValue.textContent=e;socket.emit("ball-control",{type:"speed",value:e})});movePatternSelect.addEventListener('change',()=>{socket.emit("ball-control",{type:"movePattern",value:movePatternSelect.value});updatePreviewDirection()});audioToggle.addEventListener('change',()=>socket.emit("ball-control",{type:"audioToggle",value:audioToggle.checked}));
      // ★修正②③: 色選択とプレビューのイベントリスナーを復活
      ballColorSelect.addEventListener('change',()=>{socket.emit("ball-control",{type:"ballColor",value:ballColorSelect.value});previewBall.style.backgroundColor=ballColorSelect.value});
      bgColorSelect.addEventListener('change',()=>{socket.emit("ball-control",{type:"bgColor",value:bgColorSelect.value});previewArea.style.backgroundColor=bgColorSelect.value});
      document.addEventListener('keydown',(e)=>{if(e.key==='Enter'){e.preventDefault();toggleMoveBtn.click()}if(e.key==='ArrowRight'){e.preventDefault();speedSlider.value=Math.min(parseInt(speedSlider.value)+1,100);speedSlider.dispatchEvent(new Event('input'))}if(e.key==='ArrowLeft'){e.preventDefault();speedSlider.value=Math.max(parseInt(speedSlider.value)-1,1);speedSlider.dispatchEvent(new Event('input'))}});socket.on("ball-control",(e)=>{if(e.type==="ballColor"){ballColorSelect.value=e.value;previewBall.style.backgroundColor=e.value}if(e.type==="bgColor"){bgColorSelect.value=e.value;previewArea.style.backgroundColor=e.value}});
      socket.on('connect',()=>console.log('サーバーに接続'));socket.on('disconnect',(e)=>console.log('サーバーから切断:',e));
      const ballColors=["#FFFFFF","#FFE3CB","#FFB3BF","#F5CEE6","#C5E8F2","#C3D4F3","#BCE0DF","#DFF5D6","#FFFAD1","#8AB5E6","#E68D8A","#B5E68A","#4E7199","#99514E","#4E9967","#FF0000","#000000"],bgColors=["#000000","#282c34","#36454F","#5a5a5a","#FFFFFF","#EAEAEA","#F5F5DC","#ADD8E6"];function populateColorSelect(e,t){t.forEach(o=>{const l=document.createElement("option");l.value=o,l.textContent=`⬛ ${o}`,l.style.backgroundColor=o,l.style.color=getContrastYIQ(o)==="black"?"#000":"#fff";e.appendChild(l)})}function getContrastYIQ(e){e=e.replace("#","");const t=parseInt(e.substr(0,2),16),o=parseInt(e.substr(2,2),16),l=parseInt(e.substr(4,2),16);return(t*299+o*587+l*114)/1e3>=128?"black":"white"}populateColorSelect(ballColorSelect,ballColors);populateColorSelect(bgColorSelect,bgColors);resetPreviewBallPosition();
    });
  </script>
</body>
</html>
