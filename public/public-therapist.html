<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>EMDR Control Panel</title>
  <style>
    body { font-family: sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; }
    #controlPanel { display: flex; flex-wrap: wrap; gap: 20px; max-width: 800px; margin: auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .control-group { border: 1px solid #ddd; border-radius: 8px; padding: 15px; flex: 1 1 250px; min-width: 250px; }
    .control-group label { display: block; font-weight: bold; margin-bottom: 10px; color: #555; }
    .control-group button, .control-group select, .control-group input { width: calc(100% - 20px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 15px; }
    .control-group button { background-color: #5c67f2; color: white; border: none; cursor: pointer; transition: background-color 0.2s; }
    .control-group button:hover { background-color: #4a54c2; }
    #stopBtn { background-color: #f25c5c; }
    #stopBtn:hover { background-color: #c24a4a; }
    .toggle-switch { display: flex; align-items: center; gap: 10px; }
    .toggle-switch span { font-size: 14px; }
    #volumeSlider { width: 120px; vertical-align: middle; }
    #musicToggleBtn { width: auto; padding: 10px 20px; }
  </style>
</head>
<body>

  <div id="controlPanel">
    <div class="control-group">
      <label>基本操作</label>
      <button id="startBtn">開始</button>
      <button id="stopBtn">停止</button>
    </div>
    
    <div class="control-group">
      <label for="movePattern">動きのパターン</label>
      <select id="movePattern">
        <option value="horizontal">水平</option>
        <option value="diagonal1">斜め（＼）</option>
        <option value="diagonal2">斜め（／）</option>
      </select>
    </div>

    <div class="control-group">
      <label for="speedSlider">速さ: <span id="speedValue">5</span></label>
      <!-- ▼▼▼ 修正点: 速度上限を100に変更 ▼▼▼ -->
      <input type="range" id="speedSlider" min="1" max="100" value="5" />
    </div>

    <div class="control-group">
      <label>ボールと背景の色</label>
      <select id="ballColor"></select>
      <select id="bgColor"></select>
    </div>

    <div class="control-group">
      <label>サウンド</label>
      <div class="toggle-switch">
        <span>衝突音</span>
        <input type="checkbox" id="audioToggle" />
      </div>
    </div>
    
    <div class="control-group">
      <label>BGM操作</label>
      <div>
        <button id="musicToggleBtn">再生</button>
        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5" title="音量">
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const socket = io();

      // --- DOM要素の取得 ---
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const speedSlider = document.getElementById('speedSlider');
      const speedValue = document.getElementById('speedValue');
      const movePatternSelect = document.getElementById('movePattern');
      const audioToggle = document.getElementById('audioToggle');
      const ballColorSelect = document.getElementById('ballColor');
      const bgColorSelect = document.getElementById('bgColor');
      const musicToggleBtn = document.getElementById('musicToggleBtn');
      const volumeSlider = document.getElementById('volumeSlider');
      
      // --- 状態管理変数 ---
      let isBallMoving = false; // ボールの動作状態を管理

      // --- BGM関連の変数 ---
      const audioPlayer = new Audio();
      const musicPlaylist = [
          '/audio/1 Blue Berry Pufffin.mp3', '/audio/2 A Step In The River.mp3',
          '/audio/3 Peak\'s Performance.mp3', '/audio/4 Jazz Hoyt.mp3',
          '/audio/5 Pop\'s Trilogy.mp3', '/audio/6 Redemption.mp3',
          '/audio/7 Oceanic Fellings.mp3', '/audio/8 Paco Bell.mp3',
          '/audio/9 Round The Lake.mp3', '/audio/10 Piano R Squared.mp3',
          '/audio/11 New (No) Frills - Shaken, Not Stirred.mp3'
      ];
      let shuffledPlaylist = [];
      let currentTrackIndex = 0;

      // --- 関数定義 ---
      function shufflePlaylist(array) {
          const newArray = [...array];
          for (let i = newArray.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
          }
          return newArray;
      }
      
      // ▼▼▼ 修正点: BGM再生ロジックを堅牢化 (async/await使用) ▼▼▼
      async function playNextSong() {
        if (shuffledPlaylist.length === 0 || currentTrackIndex >= shuffledPlaylist.length) {
          shuffledPlaylist = shufflePlaylist(musicPlaylist);
          currentTrackIndex = 0;
        }
        
        const trackToPlay = shuffledPlaylist[currentTrackIndex];
        audioPlayer.src = trackToPlay;
        
        try {
          await audioPlayer.play();
          musicToggleBtn.textContent = '停止';
          socket.emit('music-control', { type: 'play', src: trackToPlay });
        } catch (error) {
          console.error("BGMの再生に失敗しました:", error);
          musicToggleBtn.textContent = '再生'; // 失敗したらUIを元に戻す
        }
      }
      
      function pauseMusic() {
        audioPlayer.pause();
        musicToggleBtn.textContent = '再生';
        socket.emit('music-control', { type: 'pause' });
      }

      // --- イベントリスナー ---
      startBtn.addEventListener('click', () => {
        isBallMoving = true;
        socket.emit("ball-control", { type: "start" });
      });

      stopBtn.addEventListener('click', () => {
        isBallMoving = false;
        socket.emit("ball-control", { type: "stop" });
      });

      speedSlider.addEventListener('input', () => {
        const speed = parseInt(speedSlider.value, 10);
        speedValue.textContent = speed;
        socket.emit("ball-control", { type: "speed", value: speed });
      });

      movePatternSelect.addEventListener('change', () => socket.emit("ball-control", { type: "movePattern", value: movePatternSelect.value }));
      audioToggle.addEventListener('change', () => socket.emit("ball-control", { type: "audioToggle", value: audioToggle.checked }));
      ballColorSelect.addEventListener('change', () => socket.emit("ball-control", { type: "ballColor", value: ballColorSelect.value }));
      bgColorSelect.addEventListener('change', () => socket.emit("ball-control", { type: "bgColor", value: bgColorSelect.value }));

      // BGM関連のイベントリスナー
      musicToggleBtn.addEventListener('click', async () => {
        if (audioPlayer.paused) {
          await playNextSong();
        } else {
          pauseMusic();
        }
      });
      
      volumeSlider.addEventListener('input', () => {
          audioPlayer.volume = volumeSlider.value;
          socket.emit('music-control', { type: 'volume', value: volumeSlider.value });
      });
      
      audioPlayer.addEventListener('ended', () => {
          currentTrackIndex++;
          playNextSong();
      });

      // ▼▼▼ 修正点: キーボード操作の復活 ▼▼▼
      document.addEventListener('keydown', (e) => {
        // Enterキーで開始/停止をトグル
        if (e.key === 'Enter') {
          if (isBallMoving) {
            stopBtn.click();
          } else {
            startBtn.click();
          }
        }
        // 矢印キーで速度を調整
        if (e.key === 'ArrowUp' || e.key === 'ArrowRight') {
          e.preventDefault();
          speedSlider.value = Math.min(parseInt(speedSlider.value) + 1, 100);
          speedSlider.dispatchEvent(new Event('input')); // イベントを発火させてサーバーに通知
        }
        if (e.key === 'ArrowDown' || e.key === 'ArrowLeft') {
          e.preventDefault();
          speedSlider.value = Math.max(parseInt(speedSlider.value) - 1, 1);
          speedSlider.dispatchEvent(new Event('input')); // イベントを発火させてサーバーに通知
        }
      });
      
      // クライアントからのボールの色変更通知
      socket.on("ball-control", (data) => {
        if (data.type === "ballColor") {
          ballColorSelect.value = data.value;
        }
      });

      // 接続維持と監視
      setInterval(() => socket.emit('ping'), 30000);
      socket.on('connect', () => console.log('サーバーに接続しました。 ID:', socket.id));
      socket.on('disconnect', (reason) => console.log('サーバーから切断されました。理由:', reason));

      // --- 初期化処理 ---
      const ballColors = [ "#FFFFFF", "#FFE3CB", "#FFB3BF", "#F5CEE6", "#C5E8F2", "#C3D4F3", "#BCE0DF", "#DFF5D6", "#FFFAD1", "#8AB5E6", "#E68D8A", "#B5E68A", "#4E7199", "#99514E", "#4E9967", "#FF0000", "#000000" ];
      const bgColors = [ "#000000", "#282c34", "#36454F", "#5a5a5a", "#FFFFFF" ];
      
      function populateColorSelect(selectElem, colorList) {
        colorList.forEach(color => {
          const option = document.createElement("option");
          option.value = color;
          option.textContent = `⬛ ${color}`;
          option.style.backgroundColor = color;
          option.style.color = getContrastYIQ(color) === "black" ? "#000" : "#fff";
          selectElem.appendChild(option);
        });
      }
      function getContrastYIQ(hexcolor) {
        hexcolor = hexcolor.replace("#", "");
        const r = parseInt(hexcolor.substr(0,2),16), g = parseInt(hexcolor.substr(2,2),16), b = parseInt(hexcolor.substr(4,2),16);
        return ((r*299)+(g*587)+(b*114))/1000 >= 128 ? 'black' : 'white';
      }

      populateColorSelect(ballColorSelect, ballColors);
      populateColorSelect(bgColorSelect, bgColors);
      shuffledPlaylist = shufflePlaylist(musicPlaylist);
    });
  </script>
</body>
</html>
