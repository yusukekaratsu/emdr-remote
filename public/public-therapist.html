<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>EMDR Therapist Control</title>
  <style>
    /* スタイルは変更なし */
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: sans-serif; }
    #controlPanel { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(255, 255, 255, 0.95); padding: 15px 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); z-index: 10; display: flex; align-items: flex-start; justify-content: center; gap: 20px; flex-wrap: wrap; }
    .control-item { text-align: center; }
    .control-item label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: bold; color: #333; }
    #slider { width: 180px; }
    #startBtn, #stopBtn { padding: 8px 16px; margin: 0 4px; font-size: 14px; cursor: pointer; }
    .button-group { padding-top: 20px; }
    select { padding: 5px; font-size: 14px; }
    #ball { width: 50px; height: 50px; border-radius: 50%; position: absolute; top: 50%; transform: translateY(-50%); background-color: #FFB3BF; }
    option { padding: 4px; }
  </style>
</head>
<body style="background-color: #000000;">

  <div id="controlPanel">
    <div class="control-item">
      <label for="slider">速度: <span id="speedDisplay">5</span></label>
      <input type="range" id="slider" min="1" max="100" value="5" />
    </div>
    <div class="control-item button-group">
      <button id="startBtn">スタート</button>
      <button id="stopBtn">ストップ</button>
    </div>
    <div class="control-item">
      <label for="ballColor">ボール色</label>
      <select id="ballColor"></select>
    </div>
    <div class="control-item">
      <label for="bgColor">背景色</label>
      <select id="bgColor"></select>
    </div>
    <div class="control-item">
      <label for="soundType">音の種類</label>
      <!-- ▼ここから修正▼: 音の選択肢を3つに -->
      <select id="soundType">
        <option value="none">音なし</option>
        <option value="pingpong">ピンポン</option>
        <option value="bell">穏やかなベル</option>
        <option value="drop">水滴</option>
      </select>
      <!-- ▲ここまで修正▲ -->
    </div>
  </div>
  
  <div id="ball"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // JavaScriptの前半部分は変更なし
    const socket = io();
    const slider = document.getElementById("slider");
    // ... 他の要素の取得も同様 ...
    const soundType = document.getElementById("soundType");
    // ... 変数定義も同様 ...
    let audioCtx = null;


    // ▼▼▼ ここから moveBall 関数を修正 ▼▼▼
    function moveBall() {
      const ballWidth = 50;
      const screenWidth = window.innerWidth;
      if (isStopping) {
        // 停止処理は変更なし
        const center = (screenWidth - ballWidth) / 2;
        stopProgress += 1 / stopDuration;
        if (stopProgress >= 1) {
          position = center;
          ball.style.left = position + "px";
          cancelAnimationFrame(animationId);
          animationId = null;
          isStopping = false;
          return;
        } else {
          const currentSpeed = initialSpeed * Math.pow(1 - stopProgress, 2);
          const delta = center - position;
          const moveDirection = delta > 0 ? 1 : -1;
          position += moveDirection * Math.min(Math.abs(delta), currentSpeed);
        }
      } else {
        position += direction * speed;
        if (position <= 0 || position + ballWidth >= screenWidth) {
          direction *= -1;
          position = Math.max(0, Math.min(position, screenWidth - ballWidth));
          
          // ステレオのパン値を決定 (-1:左, 1:右)
          // ボールが左端に当たった時(directionが1になった時)は左から音を出す
          const panValue = (direction === 1) ? -1 : 1;
          playSound(soundType.value, panValue); // panValueを渡す
        }
      }
      ball.style.left = position + "px";
      animationId = requestAnimationFrame(moveBall);
    }
    // ▲▲▲ ここまで moveBall 関数を修正 ▲▲▲


    // ▼▼▼ ここから playSound 関数を修正 ▼▼▼
    function playSound(type, panValue = 0) { // panValue引数を追加
      if (!audioCtx || type === 'none') return;
      const now = audioCtx.currentTime;

      // ステレオパンナーを作成
      const panner = audioCtx.createStereoPanner();
      panner.pan.setValueAtTime(panValue, now);
      panner.connect(audioCtx.destination);

      const gainNode = audioCtx.createGain();
      gainNode.connect(panner); // 出力をパンナーに接続
      gainNode.gain.setValueAtTime(0, now);

      switch(type) {
        case 'pingpong': { // 「ピンポン」音を追加
          const osc = audioCtx.createOscillator();
          osc.type = 'sine';
          osc.frequency.setValueAtTime(1000, now);
          
          gainNode.gain.linearRampToValueAtTime(0.4, now + 0.01);
          gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 0.2);

          osc.connect(gainNode);
          osc.start(now);
          osc.stop(now + 0.2);
          break;
        }
        case 'bell': {
          const osc1 = audioCtx.createOscillator();
          const osc2 = audioCtx.createOscillator();
          osc1.type = 'sine';
          osc2.type = 'sine';
          osc1.frequency.setValueAtTime(440, now);
          osc2.frequency.setValueAtTime(441.5, now);

          gainNode.gain.linearRampToValueAtTime(0.2, now + 0.01);
          gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 1.5);

          osc1.connect(gainNode);
          osc2.connect(gainNode);
          osc1.start(now);
          osc2.start(now);
          osc1.stop(now + 1.5);
          osc2.stop(now + 1.5);
          break;
        }
        case 'drop': {
          const osc = audioCtx.createOscillator();
          osc.type = 'sine';
          
          gainNode.gain.linearRampToValueAtTime(0.3, now + 0.01);
          gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 0.5);
          
          osc.frequency.setValueAtTime(900, now);
          osc.frequency.exponentialRampToValueAtTime(400, now + 0.5);

          osc.connect(gainNode);
          osc.start(now);
          osc.stop(now + 0.5);
          break;
        }
      }
    }
    // ▲▲▲ ここまで playSound 関数を修正 ▲▲▲

    // 便宜上、変更のないJavaScriptの残りの部分を省略しています。
    // 実際には前回のコードのまま残してください。
  </script>
</body>
</html>
