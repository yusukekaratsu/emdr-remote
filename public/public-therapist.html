<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>EMDR Control Panel</title>
  <style>
    body { font-family: sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; }
    #controlPanel { display: flex; flex-wrap: wrap; gap: 20px; max-width: 800px; margin: auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .control-group { border: 1px solid #ddd; border-radius: 8px; padding: 15px; flex: 1 1 250px; min-width: 250px; }
    .control-group label { display: block; font-weight: bold; margin-bottom: 10px; color: #555; }
    .control-group button, .control-group select, .control-group input { width: calc(100% - 20px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 15px; }
    .control-group button { background-color: #5c67f2; color: white; border: none; cursor: pointer; transition: background-color 0.2s; }
    .control-group button:hover { background-color: #4a54c2; }
    #toggleMoveBtn.stop-active { background-color: #f25c5c; }
    #toggleMoveBtn.stop-active:hover { background-color: #c24a4a; }
    /* ▼▼▼ 追加: 一時停止ボタンのスタイル ▼▼▼ */
    #pauseResumeBtn { background-color: #e67e22; } /* オレンジ系 */
    #pauseResumeBtn:hover { background-color: #d35400; }
    #pauseResumeBtn.resume-active { background-color: #2ecc71; } /* 緑系 (再開) */
    #pauseResumeBtn.resume-active:hover { background-color: #27ae60; }
    /* ▲▲▲ ここまで追加 ▲▲▲ */
    .toggle-switch { display: flex; align-items: center; gap: 10px; }
    #volumeSlider { width: 120px; vertical-align: middle; }
    #musicToggleBtn { width: auto; padding: 10px 20px; }
    #previewContainer { max-width: 800px; margin: 30px auto; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    #previewContainer h3 { text-align: center; color: #555; margin-top: 0; }
    #previewArea { width: 100%; height: 250px; background-color: #000000; border: 1px solid #ccc; border-radius: 8px; position: relative; overflow: hidden; transition: background-color 0.3s; }
    #previewBall { width: 30px; height: 30px; border-radius: 50%; background-color: #FFFFFF; position: absolute; }
  </style>
</head>
<body>

  <div id="controlPanel">
    <div class="control-group">
      <label>基本操作</label>
      <button id="toggleMoveBtn">開始</button>
      <!-- ▼▼▼ 追加: 一時停止/再開ボタン ▼▼▼ -->
      <button id="pauseResumeBtn">一時停止</button>
    </div>
    <div class="control-group"> <label for="movePattern">動きのパターン</label> <select id="movePattern"> <option value="horizontal">水平</option> <option value="diagonal1">斜め（＼）</option> <option value="diagonal2">斜め（／）</option> </select> </div>
    <div class="control-group"> <label for="speedSlider">速さ: <span id="speedValue">5</span></label> <input type="range" id="speedSlider" min="1" max="100" value="5" /> </div>
    <div class="control-group"> <label>ボールと背景の色</label> <select id="ballColor"></select> <select id="bgColor"></select> </div>
    <div class="control-group"> <label>サウンド</label> <div class="toggle-switch"> <span>衝突音</span> <input type="checkbox" id="audioToggle" /> </div> </div>
    <div class="control-group"> <label>BGM操作</label> <div> <button id="musicToggleBtn">再生</button> <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.7" title="音量"> </div> </div>
  </div>
  <div id="previewContainer"> <h3>クライアント画面プレビュー</h3> <div id="previewArea"> <div id="previewBall"></div> </div> </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const socket = io();
      const toggleMoveBtn = document.getElementById('toggleMoveBtn'), pauseResumeBtn = document.getElementById('pauseResumeBtn'), speedSlider = document.getElementById('speedSlider'), speedValue = document.getElementById('speedValue'), movePatternSelect = document.getElementById('movePattern'), audioToggle = document.getElementById('audioToggle'), ballColorSelect = document.getElementById('ballColor'), bgColorSelect = document.getElementById('bgColor'), musicToggleBtn = document.getElementById('musicToggleBtn'), volumeSlider = document.getElementById('volumeSlider');
      const previewArea = document.getElementById('previewArea'), previewBall = document.getElementById('previewBall');
      
      let isBallMoving = false;
      let isPaused = false; // ★追加: 一時停止状態を管理

      const audioPlayer=new Audio();const musicPlaylist=['/audio/1 Blue Berry Pufffin.mp3','/audio/2 A Step In The River.mp3','/audio/3 Peak\'s Performance.mp3','/audio/4 Jazz Hoyt.mp3','/audio/5 Pop\'s Trilogy.mp3','/audio/6 Redemption.mp3','/audio/7 Oceanic Fellings.mp3','/audio/8 Paco Bell.mp3','/audio/9 Round The Lake.mp3','/audio/10 Piano R Squared.mp3','/audio/11 New (No) Frills - Shaken, Not Stirred.mp3'];let shuffledPlaylist=[],currentTrackIndex=0;function shufflePlaylist(e){const t=[...e];for(let o=t.length-1;o>0;o--){const l=Math.floor(Math.random()*(o+1));[t[o],t[l]]=[t[l],t[o]]}return t}function playMusic(){if(shuffledPlaylist.length===0){shuffledPlaylist=shufflePlaylist(musicPlaylist);currentTrackIndex=0}const e=shuffledPlaylist[currentTrackIndex];audioPlayer.src=e;audioPlayer.play();musicToggleBtn.textContent='停止';socket.emit('music-control',{type:'play',src:e})}function pauseMusic(){audioPlayer.pause();musicToggleBtn.textContent='再生';socket.emit('music-control',{type:'pause'})}musicToggleBtn.addEventListener('click',()=>{if(audioPlayer.paused){playMusic()}else{pauseMusic()}});volumeSlider.addEventListener('input',()=>{const e=Math.pow(volumeSlider.value,2);audioPlayer.volume=e;socket.emit('music-control',{type:'volume',value:e})});audioPlayer.addEventListener('ended',()=>{currentTrackIndex++;if(currentTrackIndex>=shuffledPlaylist.length){shuffledPlaylist=shufflePlaylist(musicPlaylist);currentTrackIndex=0}playMusic()});
      
      const previewBallSize={width:30,height:30};let previewPosition,previewDirection,previewAnimationId=null;const angle=15,angleRad=angle*Math.PI/180,dirX=Math.cos(angleRad),dirY=Math.sin(angleRad);let isPreviewStopping=false,hasPreviewReachedEdge=false,previewStopProgress=0;const previewStopDuration=120;let previewReturnStartPosition;function resetPreviewBallPosition(){if(previewAnimationId)cancelAnimationFrame(previewAnimationId);previewAnimationId=null;const e=previewArea.getBoundingClientRect();previewPosition={x:(e.width-previewBallSize.width)/2,y:(e.height-previewBallSize.height)/2};previewBall.style.left=previewPosition.x+'px';previewBall.style.top=previewPosition.y+'px'}function updatePreviewDirection(){const e=movePatternSelect.value;switch(e){case'horizontal':previewDirection={x:1,y:0};break;case'diagonal1':previewDirection={x:dirX,y:dirY};break;case'diagonal2':previewDirection={x:-dirX,y:dirY};break}}function stopPreviewBall(){if(previewAnimationId&&!isPreviewStopping){isPreviewStopping=true;hasPreviewReachedEdge=false}}
      function movePreviewBall(){
          if (isPaused) { // ★追加: 一時停止中はここで処理を中断
              previewAnimationId=requestAnimationFrame(movePreviewBall);
              return;
          }
          const speed = parseInt(speedSlider.value, 10); const areaRect = previewArea.getBoundingClientRect();
          if (isPreviewStopping) { if (!hasPreviewReachedEdge) { previewPosition.x += previewDirection.x * speed; previewPosition.y += previewDirection.y * speed; if (previewPosition.x <= 0 || previewPosition.x + previewBallSize.width >= areaRect.width || previewPosition.y <= 0 || previewPosition.y + previewBallSize.height >= areaRect.height) { hasPreviewReachedEdge = true; previewReturnStartPosition = { ...previewPosition }; previewStopProgress = 0; } } else { const center = { x: (areaRect.width - previewBallSize.width) / 2, y: (areaRect.height - previewBallSize.height) / 2 }; previewStopProgress += 1 / previewStopDuration; const ease = 1 - Math.pow(1 - previewStopProgress, 3); previewPosition.x = previewReturnStartPosition.x + (center.x - previewReturnStartPosition.x) * ease; previewPosition.y = previewReturnStartPosition.y + (center.y - previewReturnStartPosition.y) * ease; if (previewStopProgress >= 1) { resetPreviewBallPosition(); isPreviewStopping = false; return; } } } else { previewPosition.x += previewDirection.x * speed; previewPosition.y += previewDirection.y * speed; if (movePatternSelect.value === 'horizontal') { if (previewPosition.x <= 0 || previewPosition.x + previewBallSize.width >= areaRect.width) previewDirection.x *= -1; } else { if (previewPosition.x <= 0 || previewPosition.x + previewBallSize.width >= areaRect.width) previewDirection.x *= -1; if (previewPosition.y <= 0 || previewPosition.y + previewBallSize.height >= areaRect.height) previewDirection.y *= -1; } }
          previewPosition.x=Math.max(0,Math.min(previewPosition.x,areaRect.width-previewBallSize.width));previewPosition.y=Math.max(0,Math.min(previewPosition.y,areaRect.height-previewBallSize.height));previewBall.style.left=previewPosition.x+'px';previewBall.style.top=previewPosition.y+'px';
          previewAnimationId=requestAnimationFrame(movePreviewBall);
      }
      
      toggleMoveBtn.addEventListener('click', () => {
          isBallMoving = !isBallMoving;
          if (isBallMoving) {
              socket.emit("ball-control", { type: "start" });
              toggleMoveBtn.textContent = '停止';
              toggleMoveBtn.classList.add('stop-active');
              isPreviewStopping = false; hasPreviewReachedEdge = false;
              updatePreviewDirection();
              if (!previewAnimationId) previewAnimationId = requestAnimationFrame(movePreviewBall);
          } else {
              socket.emit("ball-control", { type: "stop" });
              toggleMoveBtn.textContent = '開始';
              toggleMoveBtn.classList.remove('stop-active');
              stopPreviewBall();
              isPaused = false; // ★追加: 停止時は一時停止も解除
              pauseResumeBtn.textContent = '一時停止';
              pauseResumeBtn.classList.remove('resume-active');
          }
      });
      
      // ▼▼▼ 追加: 一時停止/再開ボタンのイベントリスナー ▼▼▼
      pauseResumeBtn.addEventListener('click', () => {
          if (!isBallMoving) return; // 動いていない時は何もしない
          
          isPaused = !isPaused;
          socket.emit("ball-control", { type: "pause-resume" });

          if (isPaused) {
              pauseResumeBtn.textContent = '再開';
              pauseResumeBtn.classList.add('resume-active');
          } else {
              pauseResumeBtn.textContent = '一時停止';
              pauseResumeBtn.classList.remove('resume-active');
          }
      });

      speedSlider.addEventListener('input',()=>{const e=parseInt(speedSlider.value,10);speedValue.textContent=e;socket.emit("ball-control",{type:"speed",value:e})});
      movePatternSelect.addEventListener('change',()=>{socket.emit("ball-control",{type:"movePattern",value:movePatternSelect.value});updatePreviewDirection()});
      audioToggle.addEventListener('change',()=>socket.emit("ball-control",{type:"audioToggle",value:audioToggle.checked}));
      ballColorSelect.addEventListener('change',()=>{socket.emit("ball-control",{type:"ballColor",value:ballColorSelect.value});previewBall.style.backgroundColor=ballColorSelect.value});
      bgColorSelect.addEventListener('change',()=>{socket.emit("ball-control",{type:"bgColor",value:bgColorSelect.value});previewArea.style.backgroundColor=bgColorSelect.value});
      document.addEventListener('keydown',(e)=>{if(e.key==='Enter'){e.preventDefault();toggleMoveBtn.click()}if(e.key==='ArrowRight'){e.preventDefault();speedSlider.value=Math.min(parseInt(speedSlider.value)+1,100);speedSlider.dispatchEvent(new Event('input'))}if(e.key==='ArrowLeft'){e.preventDefault();speedSlider.value=Math.max(parseInt(speedSlider.value)-1,1);speedSlider.dispatchEvent(new Event('input'))}});
      socket.on("ball-control",(e)=>{if(e.type==="ballColor"){ballColorSelect.value=e.value;previewBall.style.backgroundColor=e.value}if(e.type==="bgColor"){bgColorSelect.value=e.value;previewArea.style.backgroundColor=e.value}});
      setInterval(()=>socket.emit('ping'),30000);
      socket.on('connect',()=>console.log('サーバーに接続しました。 ID:',socket.id));
      socket.on('disconnect',(e)=>console.log('サーバーから切断されました。理由:',e));
      const ballColors=["#FFFFFF","#FFE3CB","#FFB3BF","#F5CEE6","#C5E8F2","#C3D4F3","#BCE0DF","#DFF5D6","#FFFAD1","#8AB5E6","#E68D8A","#B5E68A","#4E7199","#99514E","#4E9967","#FF0000","#000000"],bgColors=["#000000","#282c34","#36454F","#5a5a5a","#FFFFFF"];function populateColorSelect(e,t){t.forEach(o=>{const l=document.createElement("option");l.value=o;l.textContent=`⬛ ${o}`;l.style.backgroundColor=o;l.style.color=getContrastYIQ(o)==="black"?"#000":"#fff";e.appendChild(l)})}function getContrastYIQ(e){e=e.replace("#","");const t=parseInt(e.substr(0,2),16),o=parseInt(e.substr(2,2),16),l=parseInt(e.substr(4,2),16);return(t*299+o*587+l*114)/1e3>=128?"black":"white"}populateColorSelect(ballColorSelect,ballColors);populateColorSelect(bgColorSelect,bgColors);resetPreviewBallPosition();
    });
  </script>
</body>
</html>
