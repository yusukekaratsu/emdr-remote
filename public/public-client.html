<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>EMDR Client</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: sans-serif; background-color: #f0f0f0; transition: background-color 0.3s; }
    #setupScreen { position: absolute; top: 5%; left: 50%; transform: translateX(-50%); width: auto; height: auto; z-index: 20; display: flex; flex-direction: column; align-items: center; transition: opacity 0.5s; }
    #chooserWrapper { background-color: white; padding: 25px 35px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); text-align: center; display: flex; gap: 30px; }
    .color-selector label { font-size: 18px; color: #333; display: block; }
    .color-selector select { margin-top: 15px; padding: 8px; font-size: 16px; min-width: 180px; border: 1px solid #ccc; border-radius: 4px; }
    #startSessionBtn { margin-top: 30px; padding: 15px 40px; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 8px; border: none; background-color: #5c67f2; color: white; transition: background-color 0.2s; }
    #startSessionBtn:hover { background-color: #4a54c2; }
    #ball { width: 50px; height: 50px; border-radius: 50%; position: absolute; background-color: #FFFFFF; visibility: visible; }
  </style>
</head>
<body>
  <div id="setupScreen">
    <div id="chooserWrapper">
      <div class="color-selector"> <label for="clientBallColor">ボールの色</label> <select id="clientBallColor"></select> </div>
      <div class="color-selector"> <label for="clientBgColor">背景の色</label> <select id="clientBgColor"></select> </div>
    </div>
    <button id="startSessionBtn">セッションを開始</button>
  </div>
  <div id="ball"></div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded',()=>{const e=io(),t=document.getElementById("ball"),o=document.getElementById("setupScreen"),l=document.getElementById("startSessionBtn"),n=document.getElementById("clientBallColor"),c=document.getElementById("clientBgColor");let a=!1,i=!1;const d=new Audio;d.volume=.5;let r,s,u=!1,m=!1;const p={width:50,height:50};let g={x:(window.innerWidth-p.width)/2,y:(window.innerHeight-p.height)/2};t.style.left=g.x+"px",t.style.top=g.y+"px";let h={x:1,y:0},v=5,f=null,w="horizontal";let y=!1,S=!1,E=0;const B=120;let x;const k=15,L=k*Math.PI/180,M=Math.cos(L),C=Math.sin(L);let I=-1;function A(){if(m)return;try{r=new(window.AudioContext||window.webkitAudioContext),s=r.createStereoPanner(),s.connect(r.destination),m=!0}catch(e){console.error("Web Audio API is not supported.")}}function P(){if(!u||!m)return;r.state==="suspended"&&r.resume();const e=r.createOscillator(),t=r.createGain();e.type="sine",e.frequency.setValueAtTime(440,r.currentTime),e.connect(t).connect(s),s.pan.setValueAtTime(I,r.currentTime),t.gain.setValueAtTime(.5,r.currentTime),t.gain.exponentialRampToValueAtTime(1e-4,r.currentTime+.1),e.start(r.currentTime),e.stop(r.currentTime+.1),I*=-1}function b(){switch(w){case"horizontal":h={x:1,y:0};break;case"diagonal1":h={x:M,y:C};break;case"diagonal2":h={x:-M,y:C};break}}function N(){f&&!y&&(y=!0,S=!1)}
    // ▼▼▼ 修正: moveBall関数に一時停止のロジックを追加 ▼▼▼
    function T(){
      if(i){f=requestAnimationFrame(T);return} // ★追加: 一時停止中はここで処理を中断
      const e={width:window.innerWidth,height:window.innerHeight};if(y){if(!S){g.x+=h.x*v,g.y+=h.y*v;(g.x<=0||g.x+p.width>=e.width||g.y<=0||g.y+p.height>=e.height)&&(P(),S=!0,x={...g},E=0)}else{const o={x:(e.width-p.width)/2,y:(e.height-p.height)/2};E+=1/B;const l=1-Math.pow(1-E,3);g.x=x.x+(o.x-x.x)*l,g.y=x.y+(o.y-x.y)*l,E>=1&&(g=o,cancelAnimationFrame(f),f=null,y=!1,t.style.left=g.x+"px",t.style.top=g.y+"px")}}else{g.x+=h.x*v,g.y+=h.y*v,w==="horizontal"?(g.x<=0||g.x+p.width>=e.width)&&(h.x*=-1,P()):(g.x<=0||g.x+p.width>=e.width||g.y<=0||g.y+p.height>=e.height)&&(h.x*=-1,h.y*=-1,P())}g.x=Math.max(0,Math.min(g.x,e.width-p.width)),g.y=Math.max(0,Math.min(g.y,e.height-p.height)),t.style.left=g.x+"px",t.style.top=g.y+"px",f&&(f=requestAnimationFrame(T))}
    n.addEventListener("change",()=>{t.style.backgroundColor=n.value}),c.addEventListener("change",()=>{document.body.style.backgroundColor=c.value}),l.addEventListener("click",()=>{a=!0,e.emit("ball-control",{type:"ballColor",value:n.value}),e.emit("ball-control",{type:"bgColor",value:c.value}),o.style.opacity="0",setTimeout(()=>{o.style.display="none"},500),A(),r&&"suspended"===r.state&&r.resume(),d.play().catch(()=>{}),d.pause(),console.log("オーディオの準備ができました。")}),e.on("music-control",t=>{if(!a)return;switch(t.type){case"play":console.log("再生指示を受信:",t.src),d.src.endsWith(t.src)||(d.src=t.src),d.play().catch(e=>console.error("クライアントでの再生に失敗:",e));break;case"pause":d.pause();break;case"volume":d.volume=t.value;break}}),
    // ▼▼▼ 修正: socketリスナーにpause-resumeの処理を追加 ▼▼▼
    e.on("ball-control",e=>{if(!a)return;switch(e.type){case"start":y=!1,S=!1,f||(b(),f=requestAnimationFrame(T));break;case"stop":i=!1,N();break;case"pause-resume":i=!i;break;case"audioToggle":u=e.value,u&&!m&&A();break;case"movePattern":w=e.value,b();break;case"speed":v=e.value;break;case"ballColor":t.style.backgroundColor=e.value,n.value=e.value;break;case"bgColor":document.body.style.backgroundColor=e.value,c.value=e.value;break}});
    setInterval(()=>e.emit("ping"),3e4),e.on("connect",()=>console.log("サーバーに再接続しました。 ID:",e.id)),e.on("disconnect",e=>console.log("サーバーから切断されました。理由:",e));const V=["#FFFFFF","#FFE3CB","#FFB3BF","#F5CEE6","#C5E8F2","#C3D4F3","#BCE0DF","#DFF5D6","#FFFAD1","#8AB5E6","#E68D8A","#B5E68A","#4E7199","#99514E","#4E9967","#FF0000","#000000"],D=["#000000","#282c34","#36454F","#5a5a5a","#FFFFFF"];function O(e,t){t.forEach(o=>{const l=document.createElement("option");l.value=o,l.textContent=`⬛ ${o}`,l.style.backgroundColor=o,l.style.color=j(o)==="black"?"#000":"#fff",e.appendChild(l)})}function j(e){e=e.replace("#","");const t=parseInt(e.substr(0,2),16),o=parseInt(e.substr(2,2),16),l=parseInt(e.substr(4,2),16);return(299*t+587*o+114*l)/1e3>=128?"black":"white"}O(n,V),O(c,D),n.value="#FFFFFF",c.value="#000000",document.body.style.backgroundColor=c.value,window.addEventListener("resize",()=>{f||(g={x:(window.innerWidth-p.width)/2,y:(window.innerHeight-p.height)/2},t.style.left=g.x+"px",t.style.top=g.y+"px")})});
  </script>
</body>
</html>
