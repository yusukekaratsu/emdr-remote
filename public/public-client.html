<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>EMDR Client</title>
  <style>
    html, body { 
      margin: 0; 
      padding: 0; 
      height: 100%; 
      overflow: hidden; 
      font-family: sans-serif; 
      background-color: #f0f0f0;
      transition: background-color 0.3s;
    }

    /* ▼▼▼ ここからが修正箇所です ▼▼▼ */
    #setupScreen {
      position: absolute;
      /* UIを画面上部に配置 */
      top: 5%; 
      left: 50%;
      transform: translateX(-50%); /* 水平方向の中央揃え */
      
      width: auto; /* コンテンツに合わせて幅を自動調整 */
      height: auto;
      z-index: 20;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: opacity 0.5s;
    }
    #chooserWrapper {
      background-color: white;
      padding: 25px 35px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      text-align: center;
      display: flex;
      gap: 30px;
    }
    /* ▲▲▲ ここまでが修正箇所です ▲▲▲ */

    .color-selector label {
      font-size: 18px;
      color: #333;
      display: block;
    }
    .color-selector select {
      margin-top: 15px;
      padding: 8px;
      font-size: 16px;
      min-width: 180px;
    }
    #startSessionBtn {
      margin-top: 30px;
      padding: 15px 40px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 8px;
      border: none;
      background-color: #5c67f2;
      color: white;
      transition: background-color 0.2s;
    }
    #startSessionBtn:hover {
      background-color: #4a54c2;
    }
    #ball { 
      width: 50px; 
      height: 50px; 
      border-radius: 50%; 
      position: absolute;
      background-color: #FFFFFF;
      visibility: visible;
    }
  </style>
</head>
<body>

  <div id="setupScreen">
    <div id="chooserWrapper">
      <div class="color-selector">
        <label for="clientBallColor">ボールの色</label>
        <select id="clientBallColor"></select>
      </div>
      <div class="color-selector">
        <label for="clientBgColor">背景の色</label>
        <select id="clientBgColor"></select>
      </div>
    </div>
    <button id="startSessionBtn">セッションを開始</button>
  </div>

  <div id="ball"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const socket = io();
      const ball = document.getElementById("ball");
      const setupScreen = document.getElementById("setupScreen");
      const startSessionBtn = document.getElementById("startSessionBtn");
      const clientBallColorSelect = document.getElementById("clientBallColor");
      const clientBgColorSelect = document.getElementById("clientBgColor");
      let isSessionStarted = false;

      const audioPlayer = new Audio();
      audioPlayer.volume = 0.5;
      let audioContext, panner, isAudioEnabled = false, isAudioInitialized = false;

      const ballSize={width:50,height:50};let position={x:(window.innerWidth-ballSize.width)/2,y:(window.innerHeight-ballSize.height)/2};ball.style.left=position.x+"px";ball.style.top=position.y+"px";let direction={x:1,y:0},speed=5,animationId=null,movePattern='horizontal';let isStopping=false,hasReachedEdge=false,stopProgress=0;const stopDuration=120;let returnStartPosition;const angle=15,angleRad=angle*Math.PI/180;const dirX=Math.cos(angleRad),dirY=Math.sin(angleRad);let panDirection=-1;function initAudio(){if(isAudioInitialized)return;try{audioContext=new(window.AudioContext||window.webkitAudioContext)();panner=audioContext.createStereoPanner();panner.connect(audioContext.destination);isAudioInitialized=true}catch(e){console.error("Web Audio API is not supported.")}}function playCollisionSound(){if(!isAudioEnabled||!isAudioInitialized)return;if(audioContext.state==='suspended')audioContext.resume();const o=audioContext.createOscillator(),t=audioContext.createGain();o.type='sine';o.frequency.setValueAtTime(440,audioContext.currentTime);o.connect(t).connect(panner);panner.pan.setValueAtTime(panDirection,audioContext.currentTime);t.gain.setValueAtTime(.5,audioContext.currentTime);t.gain.exponentialRampToValueAtTime(1e-4,audioContext.currentTime+.1);o.start(audioContext.currentTime);o.stop(audioContext.currentTime+.1);panDirection*=-1}function updateDirection(){switch(movePattern){case'horizontal':direction={x:1,y:0};break;case'diagonal1':direction={x:dirX,y:dirY};break;case'diagonal2':direction={x:-dirX,y:dirY};break}}function stopBall(){if(animationId&&!isStopping){isStopping=true;hasReachedEdge=false}}function moveBall(){const e={width:window.innerWidth,height:window.innerHeight};if(isStopping){if(!hasReachedEdge){position.x+=direction.x*speed;position.y+=direction.y*speed;if(position.x<=0||position.x+ballSize.width>=e.width||position.y<=0||position.y+ballSize.height>=e.height){playCollisionSound();hasReachedEdge=true;returnStartPosition={...position};stopProgress=0}}else{const t={x:(e.width-ballSize.width)/2,y:(e.height-ballSize.height)/2};stopProgress+=1/stopDuration;const o=1-Math.pow(1-stopProgress,3);position.x=returnStartPosition.x+(t.x-returnStartPosition.x)*o;position.y=returnStartPosition.y+(t.y-returnStartPosition.y)*o;if(stopProgress>=1){position=t;cancelAnimationFrame(animationId);animationId=null;isStopping=false;ball.style.left=position.x+"px";ball.style.top=position.y+"px";return}}}else{position.x+=direction.x*speed;position.y+=direction.y*speed;if(movePattern==='horizontal'){if(position.x<=0||position.x+ballSize.width>=e.width){direction.x*=-1;playCollisionSound()}}else{if(position.x<=0||position.x+ballSize.width>=e.width||position.y<=0||position.y+ballSize.height>=e.height){direction.x*=-1;direction.y*=-1;playCollisionSound()}}}position.x=Math.max(0,Math.min(position.x,e.width-ballSize.width));position.y=Math.max(0,Math.min(position.y,e.height-ballSize.height));ball.style.left=position.x+"px";ball.style.top=position.y+"px";if(animationId)animationId=requestAnimationFrame(moveBall)}

      clientBallColorSelect.addEventListener('change', () => {
        ball.style.backgroundColor = clientBallColorSelect.value;
      });
      clientBgColorSelect.addEventListener('change', () => {
        document.body.style.backgroundColor = clientBgColorSelect.value;
      });

      startSessionBtn.addEventListener("click", () => {
        isSessionStarted = true;
        socket.emit("ball-control", { type: "ballColor", value: clientBallColorSelect.value });
        socket.emit("ball-control", { type: "bgColor", value: clientBgColorSelect.value });
        setupScreen.style.opacity = '0';
        setTimeout(() => { setupScreen.style.display = 'none'; }, 500);
        initAudio();
        if (audioContext && audioContext.state === 'suspended') { audioContext.resume(); }
        audioPlayer.play().catch(()=>{});
        audioPlayer.pause();
        console.log("オーディオの準備ができました。");
      });

      socket.on('music-control', (data) => { if (!isSessionStarted) return; switch (data.type) { case 'play': console.log('再生指示を受信:', data.src); if (!audioPlayer.src.endsWith(data.src)) { audioPlayer.src = data.src; } audioPlayer.play().catch(e => console.error("クライアントでの再生に失敗:", e)); break; case 'pause': audioPlayer.pause(); break; case 'volume': audioPlayer.volume = data.value; break; }});
      socket.on("ball-control", (data) => { if (!isSessionStarted) return; switch (data.type) { case "start": isStopping=false; hasReachedEdge=false; if(!animationId){updateDirection();animationId=requestAnimationFrame(moveBall)} break; case "stop": stopBall(); break; case "audioToggle": isAudioEnabled=data.value; if(isAudioEnabled&&!isAudioInitialized)initAudio(); break; case "movePattern": movePattern=data.value; updateDirection(); break; case "speed": speed=data.value; break; case "ballColor": ball.style.backgroundColor=data.value; clientBallColorSelect.value=data.value; break; case "bgColor": document.body.style.backgroundColor=data.value; clientBgColorSelect.value = data.value; break; }});
      
      setInterval(() => socket.emit('ping'), 30000);
      socket.on('connect', () => console.log('サーバーに再接続しました。 ID:', socket.id));
      socket.on('disconnect', (reason) => console.log('サーバーから切断されました。理由:', reason));
      const ballColors = [ "#FFFFFF", "#FFE3CB", "#FFB3BF", "#F5CEE6", "#C5E8F2", "#C3D4F3", "#BCE0DF", "#DFF5D6", "#FFFAD1", "#8AB5E6", "#E68D8A", "#B5E68A", "#4E7199", "#99514E", "#4E9967", "#FF0000", "#000000" ];
      const bgColors = [ "#000000", "#282c34", "#36454F", "#5a5a5a", "#FFFFFF" ];
      function populateColorSelect(selectElem,colorList){colorList.forEach(color=>{const option=document.createElement("option");option.value=color;option.textContent=`⬛ ${color}`;option.style.backgroundColor=color;option.style.color=getContrastYIQ(color)==="black"?"#000":"#fff";selectElem.appendChild(option)})}
      function getContrastYIQ(hexcolor){hexcolor=hexcolor.replace("#","");const r=parseInt(hexcolor.substr(0,2),16),g=parseInt(hexcolor.substr(2,2),16),b=parseInt(hexcolor.substr(4,2),16);return((r*299)+(g*587)+(b*114))/1000>=128?'black':'white'}
      populateColorSelect(clientBallColorSelect, ballColors);
      populateColorSelect(clientBgColorSelect, bgColors);
      clientBallColorSelect.value = "#FFFFFF"; 
      clientBgColorSelect.value = "#000000";
      document.body.style.backgroundColor = clientBgColorSelect.value;
      window.addEventListener("resize", () => { if(!animationId){position = {x:(window.innerWidth-ballSize.width)/2,y:(window.innerHeight-ballSize.height)/2};ball.style.left = position.x + 'px'; ball.style.top = position.y + 'px';}});
    });
  </script>
</body>
</html>
