<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" /><title>EMDR Client</title>
  <style>html,body{margin:0;padding:0;height:100%;overflow:hidden;font-family:sans-serif;background-color:#f0f0f0;transition:background-color .3s}#setupScreen{position:absolute;top:5%;left:50%;transform:translateX(-50%);width:auto;height:auto;z-index:20;display:flex;flex-direction:column;align-items:center;transition:opacity .5s}#chooserWrapper{background-color:#fff;padding:25px 35px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.15);text-align:center;display:flex;gap:30px}.color-selector label{font-size:18px;color:#333;display:block}.color-selector select{margin-top:15px;padding:8px;font-size:16px;min-width:180px;border:1px solid #ccc;border-radius:4px}#startSessionBtn{margin-top:30px;padding:15px 40px;font-size:18px;font-weight:700;cursor:pointer;border-radius:8px;border:none;background-color:#5c67f2;color:#fff;transition:background-color .2s}#startSessionBtn:hover{background-color:#4a54c2}#ball{width:50px;height:50px;border-radius:50%;position:absolute;background-color:#fff;visibility:visible}</style>
</head>
<body>
  <div id="setupScreen">
    <div id="chooserWrapper"><div class="color-selector"><label for="clientBallColor">ボールの色</label><select id="clientBallColor"></select></div><div class="color-selector"><label for="clientBgColor">背景の色</label><select id="clientBgColor"></select></div></div>
    <button id="startSessionBtn">セッションを開始</button>
  </div>
  <div id="ball"></div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const socket = io();
      const ball = document.getElementById('ball'), setupScreen = document.getElementById('setupScreen'), startSessionBtn = document.getElementById('startSessionBtn'), clientBallColorSelect = document.getElementById('clientBallColor'), clientBgColorSelect = document.getElementById('clientBgColor');
      let isSessionStarted = false, isPaused = false;
      let audioContext, panner, isAudioEnabled = false, isAudioInitialized = false, collisionSoundType = 'sine_high', masterVolume = 0.5;
      const bgmAudio = new Audio(); let bgmSource, bgmGainNode;
      const musicPlaylist=['/audio/1 Blue Berry Pufffin.mp3','/audio/2 A Step In The River.mp3','/audio/3 Peak\'s Performance.mp3','/audio/4 Jazz Hoyt.mp3','/audio/5 Pop\'s Trilogy.mp3','/audio/6 Redemption.mp3','/audio/7 Oceanic Fellings.mp3','/audio/8 Paco Bell.mp3','/audio/9 Round The Lake.mp3','/audio/10 Piano R Squared.mp3','/audio/11 New (No) Frills - Shaken, Not Stirred.mp3'];
      let shuffledPlaylist=[], currentTrackIndex=0;
      function shufflePlaylist(e){const t=[...e];for(let o=t.length-1;o>0;o--){const l=Math.floor(Math.random()*(o+1));[t[o],t[l]]=[t[l],t[o]]}return t}
      function playMusic(trackIndex){if(shuffledPlaylist.length===0)shuffledPlaylist=shufflePlaylist(musicPlaylist);currentTrackIndex=(trackIndex+shuffledPlaylist.length)%shuffledPlaylist.length;bgmAudio.src=shuffledPlaylist[currentTrackIndex];bgmAudio.play().then(()=>{if(bgmGainNode.gain.value===0){bgmGainNode.gain.linearRampToValueAtTime(masterVolume,audioContext.currentTime+1)}}).catch(e=>{});}
      bgmAudio.addEventListener('ended',()=>playMusic(currentTrackIndex+1));
      function initAudio(){if(isAudioInitialized)return;try{audioContext=new(window.AudioContext||window.webkitAudioContext)();panner=audioContext.createStereoPanner();panner.connect(audioContext.destination);bgmSource=audioContext.createMediaElementSource(bgmAudio);bgmGainNode=audioContext.createGain();bgmGainNode.gain.value=0;bgmSource.connect(bgmGainNode).connect(audioContext.destination);isAudioInitialized=true}catch(e){console.error("Web Audio API not supported.")}}
      const ballSize={width:50,height:50};let position={x:(window.innerWidth-ballSize.width)/2,y:(window.innerHeight-ballSize.height)/2};ball.style.left=position.x+"px",ball.style.top=position.y+"px";let direction={x:1,y:0},speed=5,animationId=null,movePattern='horizontal';let isStopping=false,hasReachedEdge=false,stopProgress=0;const stopDuration=120;let returnStartPosition;const angle=15,angleRad=angle*Math.PI/180,dirX=Math.cos(angleRad),dirY=Math.sin(angleRad);let panDirection=-1;
      function playCollisionSound(){if(!isAudioEnabled||!isAudioInitialized)return;if(audioContext.state==='suspended')audioContext.resume();const o=audioContext.createOscillator(),t=audioContext.createGain();o.connect(t).connect(panner);t.gain.setValueAtTime(masterVolume*.8,audioContext.currentTime);panner.pan.setValueAtTime(panDirection,audioContext.currentTime);switch(collisionSoundType){case'sine_low':o.type='sine';o.frequency.setValueAtTime(220,audioContext.currentTime);t.gain.exponentialRampToValueAtTime(1e-4,audioContext.currentTime+.1);break;case'click':o.type='square';o.frequency.setValueAtTime(1e3,audioContext.currentTime);t.gain.exponentialRampToValueAtTime(1e-4,audioContext.currentTime+.05);break;default:o.type='sine';o.frequency.setValueAtTime(440,audioContext.currentTime);t.gain.exponentialRampToValueAtTime(1e-4,audioContext.currentTime+.1)}o.start(audioContext.currentTime);o.stop(audioContext.currentTime+.1);panDirection*=-1}
      function updateDirection(){switch(movePattern){case'horizontal':direction={x:1,y:0};break;case'diagonal1':direction={x:dirX,y:dirY};break;case'diagonal2':direction={x:-dirX,y:dirY};break}}function stopBall(){if(animationId&&!isStopping){isStopping=true;hasReachedEdge=false}}
      function moveBall(){if(isPaused){animationId=requestAnimationFrame(moveBall);return}const e={width:window.innerWidth,height:window.innerHeight};if(isStopping){if(!hasReachedEdge){position.x+=direction.x*speed;position.y+=direction.y*speed;(position.x<=0||position.x+ballSize.width>=e.width||position.y<=0||position.y+ballSize.height>=e.height)&&(playCollisionSound(),hasReachedEdge=true,returnStartPosition={...position},stopProgress=0)}else{const t={x:(e.width-ballSize.width)/2,y:(e.height-ballSize.height)/2};stopProgress+=1/stopDuration;const o=1-Math.pow(1-stopProgress,3);position.x=returnStartPosition.x+(t.x-returnStartPosition.x)*o;position.y=returnStartPosition.y+(t.y-returnStartPosition.y)*o;if(stopProgress>=1){position=t;cancelAnimationFrame(animationId);animationId=null;isStopping=false;ball.style.left=position.x+"px";ball.style.top=position.y+"px";return}}}else{position.x+=direction.x*speed;position.y+=direction.y*speed;if(movePattern!=='horizontal'&&(position.x<=0||position.x+ballSize.width>=e.width||position.y<=0||position.y+ballSize.height>=e.height)){direction.x*=-1;direction.y*=-1;playCollisionSound()}else if(movePattern==='horizontal'&&(position.x<=0||position.x+ballSize.width>=e.width)){direction.x*=-1;playCollisionSound()}}position.x=Math.max(0,Math.min(position.x,e.width-ballSize.width));position.y=Math.max(0,Math.min(position.y,e.height-ballSize.height));ball.style.left=position.x+"px";ball.style.top=position.y+"px";if(animationId)animationId=requestAnimationFrame(moveBall)}
      // ★修正①: 色プレビューのイベントリスナーを復活
      clientBallColorSelect.addEventListener('change',()=>ball.style.backgroundColor=clientBallColorSelect.value);
      clientBgColorSelect.addEventListener('change',()=>document.body.style.backgroundColor=clientBgColorSelect.value);
      startSessionBtn.addEventListener("click",()=>{isSessionStarted=true;initAudio();if(audioContext.state==='suspended')audioContext.resume();socket.emit("ball-control",{type:"ballColor",value:clientBallColorSelect.value});socket.emit("ball-control",{type:"bgColor",value:clientBgColorSelect.value});setupScreen.style.opacity='0';setTimeout(()=>setupScreen.style.display='none',500)},{once:true});
      socket.on("music-control",e=>{if(!isSessionStarted||!isAudioInitialized)return;switch(e.type){case'play':playMusic(currentTrackIndex);break;case'pause':if(!bgmAudio.paused){bgmGainNode.gain.linearRampToValueAtTime(0,audioContext.currentTime+1);setTimeout(()=>bgmAudio.pause(),1e3)}break;case'next':playMusic(currentTrackIndex+1);break;case'prev':playMusic(currentTrackIndex-1);break}});
      socket.on("ball-control",e=>{if(!isSessionStarted)return;switch(e.type){case"start":isStopping=false;hasReachedEdge=false;if(!animationId){updateDirection();animationId=requestAnimationFrame(moveBall)}break;case"stop":isPaused=false,stopBall();break;case"pause-resume":isPaused=!isPaused;break;case"audioToggle":isAudioEnabled=e.value;break;case"movePattern":movePattern=e.value;updateDirection();break;case"speed":speed=e.value;break;case"ballColor":ball.style.backgroundColor=e.value,clientBallColorSelect.value=e.value;break;case"bgColor":document.body.style.backgroundColor=e.value,clientBgColorSelect.value=e.value;break;case"volume":masterVolume=e.value;if(isAudioInitialized&&!bgmAudio.paused)bgmGainNode.gain.linearRampToValueAtTime(masterVolume,audioContext.currentTime+.1);break;case"collisionSound":collisionSoundType=e.value;break}});
      socket.on('connect',()=>console.log("サーバーに再接続"));socket.on('disconnect',e=>console.log("サーバーから切断:",e));
      const ballColors=["#FFFFFF","#FFE3CB","#FFB3BF","#F5CEE6","#C5E8F2","#C3D4F3","#BCE0DF","#DFF5D6","#FFFAD1","#8AB5E6","#E68D8A","#B5E68A","#4E7199","#99514E","#4E9967","#FF0000","#000000"],bgColors=["#000000","#282c34","#36454F","#5a5a5a","#FFFFFF","#EAEAEA","#F5F5DC","#ADD8E6"];function populateColorSelect(e,t){t.forEach(o=>{const l=document.createElement("option");l.value=o,l.textContent=`⬛ ${o}`,l.style.backgroundColor=o,l.style.color=getContrastYIQ(o)==="black"?"#000":"#fff";e.appendChild(l)})}function getContrastYIQ(e){e=e.replace("#","");const t=parseInt(e.substr(0,2),16),o=parseInt(e.substr(2,2),16),l=parseInt(e.substr(4,2),16);return(t*299+o*587+l*114)/1e3>=128?"black":"white"}populateColorSelect(clientBallColorSelect,ballColors);populateColorSelect(bgColorSelect,bgColors);clientBallColorSelect.value="#FFFFFF";clientBgColorSelect.value="#000000";document.body.style.backgroundColor=clientBgColorSelect.value;window.addEventListener("resize",()=>{if(!animationId){position={x:(window.innerWidth-ballSize.width)/2,y:(window.innerHeight-ballSize.height)/2};ball.style.left=position.x+'px';ball.style.top=position.y+'px'}});
    });
  </script>
</body>
</html>
