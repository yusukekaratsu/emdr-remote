<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- head内は変更なし -->
</head>
<body>
  <!-- body内のHTMLは変更なし -->

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // JavaScriptの前半部分は変更なし
    // ...
    let currentSoundType = 'none';
    let audioCtx = null;


    // ▼▼▼ ここから moveBall 関数を修正 ▼▼▼
    function moveBall() {
      const ballWidth = 50;
      const screenWidth = window.innerWidth;
      if (isStopping) {
        // 停止処理は変更なし
        const center = (screenWidth - ballWidth) / 2;
        stopProgress += 1 / stopDuration;
        if (stopProgress >= 1) {
          position = center;
          ball.style.left = position + "px";
          cancelAnimationFrame(animationId);
          animationId = null;
          isStopping = false;
          return;
        } else {
          const currentSpeed = initialSpeed * Math.pow(1 - stopProgress, 2);
          const delta = center - position;
          const moveDirection = delta > 0 ? 1 : -1;
          position += moveDirection * Math.min(Math.abs(delta), currentSpeed);
        }
      } else {
        position += direction * speed;
        if (position <= 0 || position + ballWidth >= screenWidth) {
          direction *= -1;
          position = Math.max(0, Math.min(position, screenWidth - ballWidth));
          
          // ステレオのパン値を決定 (-1:左, 1:右)
          const panValue = (direction === 1) ? -1 : 1;
          playSound(currentSoundType, panValue); // panValueを渡す
        }
      }
      ball.style.left = position + "px";
      animationId = requestAnimationFrame(moveBall);
    }
    // ▲▲▲ ここまで moveBall 関数を修正 ▲▲▲


    // ▼▼▼ ここから playSound 関数を修正 ▼▼▼
    function playSound(type, panValue = 0) { // panValue引数を追加
      if (!audioCtx || type === 'none') return;
      const now = audioCtx.currentTime;

      // ステレオパンナーを作成
      const panner = audioCtx.createStereoPanner();
      panner.pan.setValueAtTime(panValue, now);
      panner.connect(audioCtx.destination);

      const gainNode = audioCtx.createGain();
      gainNode.connect(panner); // 出力をパンナーに接続
      gainNode.gain.setValueAtTime(0, now);

      switch(type) {
        case 'pingpong': {
          const osc = audioCtx.createOscillator();
          osc.type = 'sine';
          osc.frequency.setValueAtTime(1000, now);
          gainNode.gain.linearRampToValueAtTime(0.4, now + 0.01);
          gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 0.2);
          osc.connect(gainNode);
          osc.start(now);
          osc.stop(now + 0.2);
          break;
        }
        case 'bell': {
          const osc1 = audioCtx.createOscillator();
          const osc2 = audioCtx.createOscillator();
          osc1.type = 'sine';
          osc2.type = 'sine';
          osc1.frequency.setValueAtTime(440, now);
          osc2.frequency.setValueAtTime(441.5, now);
          gainNode.gain.linearRampToValueAtTime(0.2, now + 0.01);
          gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 1.5);
          osc1.connect(gainNode);
          osc2.connect(gainNode);
          osc1.start(now);
          osc2.start(now);
          osc1.stop(now + 1.5);
          osc2.stop(now + 1.5);
          break;
        }
        case 'drop': {
          const osc = audioCtx.createOscillator();
          osc.type = 'sine';
          gainNode.gain.linearRampToValueAtTime(0.3, now + 0.01);
          gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 0.5);
          osc.frequency.setValueAtTime(900, now);
          osc.frequency.exponentialRampToValueAtTime(400, now + 0.5);
          osc.connect(gainNode);
          osc.start(now);
          osc.stop(now + 0.5);
          break;
        }
      }
    }
    // ▲▲▲ ここまで playSound 関数を修正 ▲▲▲

    // 便宜上、変更のないJavaScriptの残りの部分を省略しています。
    // 実際には前回のコードのまま残してください。
  </script>
</body>
</html>
