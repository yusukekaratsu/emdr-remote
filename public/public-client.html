<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>EMDR Client</title>
  <style>
    /* ... スタイルは変更なし ... */
  </style>
</head>
<body>
  <div id="colorChooser">
    <!-- ... HTMLは変更なし ... -->
  </div>
  <div id="ball"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const ball = document.getElementById("ball");
    const colorChooser = document.getElementById("colorChooser");
    const clientBallColor = document.getElementById("clientBallColor");

    let position = (window.innerWidth - 50) / 2;
    ball.style.left = position + "px";

    let direction = 1;
    let speed = 5;
    let animationId = null;
    let isStopping = false;
    let stopProgress = 0;
    const stopDuration = 120;
    let initialSpeed = speed;

    // ▼ここから追加▼: 音声関連の変数
    let audioCtx = null;
    let currentSoundType = 'none'; // 現在の音の種類を保存
    // ▲ここまで追加▲

    // ... populateColorSelect, getContrastYIQ, clientBallColorのリスナーは変更なし ...
    
    function moveBall() {
      const ballWidth = 50;
      const screenWidth = window.innerWidth;
      if (isStopping) {
        // ... 停止処理は変更なし ...
      } else {
        position += direction * speed;
        if (position <= 0 || position + ballWidth >= screenWidth) {
          direction *= -1;
          position = Math.max(0, Math.min(position, screenWidth - ballWidth));
          playSound(currentSoundType); // ▼端に到達したら音を鳴らす
        }
      }
      ball.style.left = position + "px";
      animationId = requestAnimationFrame(moveBall);
    }
    // ... moveBall内の停止ロジック、stopBall関数は前回のまま ...

    // ▼ここから追加▼: 音を再生する関数（セラピスト側と全く同じもの）
    function playSound(type) {
      if (!audioCtx || type === 'none') return;
      const now = audioCtx.currentTime;
      const gainNode = audioCtx.createGain();
      gainNode.connect(audioCtx.destination);
      gainNode.gain.setValueAtTime(0, now);

      switch(type) {
        case 'bell': {
          const osc1 = audioCtx.createOscillator();
          const osc2 = audioCtx.createOscillator();
          osc1.type = 'sine';
          osc2.type = 'sine';
          osc1.frequency.setValueAtTime(440, now);
          osc2.frequency.setValueAtTime(441.5, now);
          gainNode.gain.linearRampToValueAtTime(0.2, now + 0.01);
          gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 1.5);
          osc1.connect(gainNode);
          osc2.connect(gainNode);
          osc1.start(now);
          osc2.start(now);
          osc1.stop(now + 1.5);
          osc2.stop(now + 1.5);
          break;
        }
        case 'drop': {
          const osc = audioCtx.createOscillator();
          osc.type = 'sine';
          gainNode.gain.linearRampToValueAtTime(0.3, now + 0.01);
          gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 0.5);
          osc.frequency.setValueAtTime(900, now);
          osc.frequency.exponentialRampToValueAtTime(400, now + 0.5);
          osc.connect(gainNode);
          osc.start(now);
          osc.stop(now + 0.5);
          break;
        }
      }
    }
    // ▲ここまで追加▲

    socket.on("ball-control", (data) => {
      if (data.type === "start") {
        // ▼ここから追加▼: ユーザー操作時にAudioContextを初期化
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        // ▲ここまで追加▲
        isStopping = false;
        if (colorChooser) { colorChooser.style.display = "none"; }
        if (!animationId) { moveBall(); }
      } else if (data.type === "stop") {
        stopBall();
      } else if (data.type === "speed") {
        speed = data.value;
      } else if (data.type === "ballColor") {
        // ... 変更なし ...
      } else if (data.type === "bgColor") {
        // ... 変更なし ...
      }
      // ▼ここから追加▼: 音の種類の変更を受け取る
      else if (data.type === "soundType") {
        currentSoundType = data.value;
      }
      // ▲ここまで追加▲
    });

    // 既存のコードの残りの部分（resizeイベントなど）は変更ありません
    // ...
  </script>
   <!-- 便宜上、変更のないJavaScriptの残りの部分を省略しています。
       実際には前回のコードのまま残してください。 -->
</body>
</html>
