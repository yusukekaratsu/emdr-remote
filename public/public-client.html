<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>EMDR Client</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: sans-serif; background-color: #f0f0f0; transition: background-color 0.3s; }
    #setupScreen { position: absolute; top: 5%; left: 50%; transform: translateX(-50%); width: auto; height: auto; z-index: 20; display: flex; flex-direction: column; align-items: center; transition: opacity 0.5s; }
    #chooserWrapper { background-color: white; padding: 25px 35px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); text-align: center; display: flex; gap: 30px; }
    .color-selector label { font-size: 18px; color: #333; display: block; }
    .color-selector select {
      margin-top: 15px;
      padding: 8px;
      font-size: 16px;
      min-width: 180px;
      /* ▼▼▼ 修正点④: 枠線を明確に指定して表示崩れを防止 ▼▼▼ */
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #startSessionBtn { margin-top: 30px; padding: 15px 40px; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 8px; border: none; background-color: #5c67f2; color: white; transition: background-color 0.2s; }
    #startSessionBtn:hover { background-color: #4a54c2; }
    #ball { width: 50px; height: 50px; border-radius: 50%; position: absolute; background-color: #FFFFFF; visibility: visible; }
  </style>
</head>
<body>
  <div id="setupScreen">
    <div id="chooserWrapper">
      <div class="color-selector"> <label for="clientBallColor">ボールの色</label> <select id="clientBallColor"></select> </div>
      <div class="color-selector"> <label for="clientBgColor">背景の色</label> <select id="clientBgColor"></select> </div>
    </div>
    <button id="startSessionBtn">セッションを開始</button>
  </div>
  <div id="ball"></div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded',()=>{const e=io(),t=document.getElementById("ball"),o=document.getElementById("setupScreen"),l=document.getElementById("startSessionBtn"),n=document.getElementById("clientBallColor"),c=document.getElementById("clientBgColor");let a=!1;const i=new Audio;i.volume=.5;let d,r,s=!1,u=!1;const m={width:50,height:50};let p={x:(window.innerWidth-m.width)/2,y:(window.innerHeight-m.height)/2};t.style.left=p.x+"px",t.style.top=p.y+"px";let g={x:1,y:0},h=5,v=null,f="horizontal";let w=!1,y=!1,S=0;const E=120;let B;const x=15,k=x*Math.PI/180,L=Math.cos(k),M=Math.sin(k);let C=-1;function I(){if(u)return;try{d=new(window.AudioContext||window.webkitAudioContext),r=d.createStereoPanner(),r.connect(d.destination),u=!0}catch(e){console.error("Web Audio API is not supported.")}}function A(){if(!s||!u)return;d.state==="suspended"&&d.resume();const e=d.createOscillator(),t=d.createGain();e.type="sine",e.frequency.setValueAtTime(440,d.currentTime),e.connect(t).connect(r),r.pan.setValueAtTime(C,d.currentTime),t.gain.setValueAtTime(.5,d.currentTime),t.gain.exponentialRampToValueAtTime(1e-4,d.currentTime+.1),e.start(d.currentTime),e.stop(d.currentTime+.1),C*=-1}function P(){switch(f){case"horizontal":g={x:1,y:0};break;case"diagonal1":g={x:L,y:M};break;case"diagonal2":g={x:-L,y:M};break}}function b(){v&&!w&&(w=!0,y=!1)}function N(){const e={width:window.innerWidth,height:window.innerHeight};if(w){if(!y){p.x+=g.x*h,p.y+=g.y*h;(p.x<=0||p.x+m.width>=e.width||p.y<=0||p.y+m.height>=e.height)&&(A(),y=!0,B={...p},S=0)}else{const t={x:(e.width-m.width)/2,y:(e.height-m.height)/2};S+=1/E;const o=1-Math.pow(1-S,3);p.x=B.x+(t.x-B.x)*o,p.y=B.y+(t.y-B.y)*o,S>=1&&(p=t,cancelAnimationFrame(v),v=null,w=!1,t.style.left=p.x+"px",t.style.top=p.y+"px")}}else{p.x+=g.x*h,p.y+=g.y*h,f==="horizontal"?(p.x<=0||p.x+m.width>=e.width)&&(g.x*=-1,A()):(p.x<=0||p.x+m.width>=e.width||p.y<=0||p.y+m.height>=e.height)&&(g.x*=-1,g.y*=-1,A())}p.x=Math.max(0,Math.min(p.x,e.width-m.width)),p.y=Math.max(0,Math.min(p.y,e.height-m.height)),t.style.left=p.x+"px",t.style.top=p.y+"px",v&&(v=requestAnimationFrame(N))}n.addEventListener("change",()=>{t.style.backgroundColor=n.value}),c.addEventListener("change",()=>{document.body.style.backgroundColor=c.value}),l.addEventListener("click",()=>{a=!0,e.emit("ball-control",{type:"ballColor",value:n.value}),e.emit("ball-control",{type:"bgColor",value:c.value}),o.style.opacity="0",setTimeout(()=>{o.style.display="none"},500),I(),d&&"suspended"===d.state&&d.resume(),i.play().catch(()=>{}),i.pause(),console.log("オーディオの準備ができました。")}),e.on("music-control",t=>{if(!a)return;switch(t.type){case"play":console.log("再生指示を受信:",t.src),i.src.endsWith(t.src)||(i.src=t.src),i.play().catch(e=>console.error("クライアントでの再生に失敗:",e));break;case"pause":i.pause();break;case"volume":i.volume=t.value;break}}),e.on("ball-control",e=>{if(!a)return;switch(e.type){case"start":w=!1,y=!1,v||(P(),v=requestAnimationFrame(N));break;case"stop":b();break;case"audioToggle":s=e.value,s&&!u&&I();break;case"movePattern":f=e.value,P();break;case"speed":h=e.value;break;case"ballColor":t.style.backgroundColor=e.value,n.value=e.value;break;case"bgColor":document.body.style.backgroundColor=e.value,c.value=e.value;break}}),setInterval(()=>e.emit("ping"),3e4),e.on("connect",()=>console.log("サーバーに再接続しました。 ID:",e.id)),e.on("disconnect",e=>console.log("サーバーから切断されました。理由:",e));const D=["#FFFFFF","#FFE3CB","#FFB3BF","#F5CEE6","#C5E8F2","#C3D4F3","#BCE0DF","#DFF5D6","#FFFAD1","#8AB5E6","#E68D8A","#B5E68A","#4E7199","#99514E","#4E9967","#FF0000","#000000"],O=["#000000","#282c34","#36454F","#5a5a5a","#FFFFFF"];function T(e,t){t.forEach(o=>{const l=document.createElement("option");l.value=o,l.textContent=`⬛ ${o}`,l.style.backgroundColor=o,l.style.color=V(o)==="black"?"#000":"#fff",e.appendChild(l)})}function V(e){e=e.replace("#","");const t=parseInt(e.substr(0,2),16),o=parseInt(e.substr(2,2),16),l=parseInt(e.substr(4,2),16);return(299*t+587*o+114*l)/1e3>=128?"black":"white"}T(n,D),T(c,O),n.value="#FFFFFF",c.value="#000000",document.body.style.backgroundColor=c.value,window.addEventListener("resize",()=>{v||(p={x:(window.innerWidth-m.width)/2,y:(window.innerHeight-m.height)/2},t.style.left=p.x+"px",t.style.top=p.y+"px")})});
  </script>
</body>
</html>
